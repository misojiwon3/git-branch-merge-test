name: DIGITAL-RELAY CI/CD (hj aws)

on:
  push:
    branches: [ "deploy/aws_dev" ] # ë¸Œëœì¹˜ì—ì„œë§Œ ì§„í–‰

permissions:
  contents: read

env:
  AWS_REGION    : ap-northeast-2
  ECR_REPOSITORY: ecr-digital-relay
  DEPLOY_ENV    : latest    # dev ê°œë°œí™˜ê²½ ë°°í¬, prd ìš´ì˜í™˜ê²½ ë°°í¬ êµ¬ë¶„ íƒœê·¸


jobs:
  build:
    name   : DIGITAL-RELAY CI / CD START
    runs-on: ubuntu-latest

    steps:
      - name: SOURCE CODE CHECKOUT
        uses: actions/checkout@v3

      # JDK ì„¤ì • (í•„ìš”í•œ ê²½ìš°)
      - name: SET UP JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      # Gradle ë¹Œë“œ
      - name: Build with Gradle
        run: ./gradlew :app-relay:clean :app-relay:build

      - name: CONFIGURE AWS CREDENTIALS
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.ENS_AWS_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.ENS_AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

     # ECR ë¡œê·¸ì¸
      - name: LOGIN TO AMAZON ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v1

      # ì´ë¯¸ì§€ ë¹Œë“œ
      - name: BUILD DOCKER IMAGE WITH DOCKER COMPOSE
        id: build-image
        run: docker compose -f docker-compose.yml build app

      # ì´ë¯¸ì§€ ë¦¬ìŠ¤íŠ¸
      - name: LIST DOCKER IMAGES
        run: docker images

      - name: Run Trivy scan
        uses: aquasecurity/trivy-action@master
        id: trivy
        with:
            image-ref: 'digital-relay-app:latest'  # ë¡œì»¬ ë¹Œë“œ ì´ë¯¸ì§€ ìŠ¤ìº”
            format: 'json'
            # exit-code: '1'
            ignore-unfixed: true
            vuln-type: 'os,library'
            severity: 'CRITICAL,HIGH'
            output: trivy-result.json

      # ë„ì»¤ ì»´í¬ì¦ˆë¥¼ ì‚¬ìš©í•˜ì—¬ ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
      - name: TAG AND PUSH DOCKER IMAGE TO ECR
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ env.DEPLOY_ENV }}
        run: |
          docker tag   digital-relay-app:latest $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
      # - name: Send Webhook Notification
      #   run: |
      #      GITHUB_ACTOR=${{ github.actor }}
      #      GITHUB_REPOSITORY=${{ github.repository }}
      #      GITHUB_REF=${{ github.ref }}
      #      MESSAGE_CONTENT="âœ…[DIGITAL-RELAY] main push ğŸ€ğŸ€ğŸ€\n"
      #      MESSAGE_CONTENT+="$GITHUB_REPOSITORY\n"
      #      MESSAGE_CONTENT+="$GITHUB_REF\n"
      #      MESSAGE_CONTENT+="ì‘ì—…ì: $GITHUB_ACTOR\n"

      #      curl -X POST -H "Content-Type: application/json" \
      #      -d "{\"text\": \"$MESSAGE_CONTENT\"}" \
      #      https://webexapis.com/v1/webhooks/incoming/Y2lzY29zcGFyazovL3VzL1dFQkhPT0svMzQ1NDZiN2UtY2YyMS00ZWQ4LTllMjYtMDFjNWEzZTYyNDU0

